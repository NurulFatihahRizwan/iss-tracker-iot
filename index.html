<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üåç ISS Live Tracker Dashboard</title>
    <link 
      rel="stylesheet" 
      href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: #001F3F;
            color: white;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
            margin-top: 20px;
            font-weight: 700;
        }
        .info {
            text-align: center;
            margin: 10px 0;
        }
        #map {
            height: 450px;
            width: 90%;
            margin: 20px auto;
            border: 2px solid cyan;
            border-radius: 10px;
        }
        .charts {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            margin: 20px;
        }
        canvas {
            background: #012F5F;
            border-radius: 10px;
            padding: 10px;
        }
        a {
            color: cyan;
            text-decoration: none;
        }
    </style>
</head>
<body>

<h1>üåç ISS Live Tracker Dashboard</h1>

<div class="info">
    <p>Latest Data Collected: <span id="timestamp">--</span></p>
    <p>Current ISS Altitude: <span id="altitude">--</span> km</p>
</div>

<div id="map"></div>

<div class="charts">
    <canvas id="latChart" width="400" height="200"></canvas>
    <canvas id="lonChart" width="400" height="200"></canvas>
    <canvas id="altChart" width="400" height="200"></canvas>
</div>

<script>
    // Leaflet map setup
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const issMarker = L.marker([0, 0]).addTo(map).bindPopup("ISS Position");

    // Chart.js setup
    const latCtx = document.getElementById('latChart').getContext('2d');
    const lonCtx = document.getElementById('lonChart').getContext('2d');
    const altCtx = document.getElementById('altChart').getContext('2d');

    const latChart = new Chart(latCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Latitude', data: [], borderColor: 'cyan', fill: false }] },
        options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });

    const lonChart = new Chart(lonCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Longitude', data: [], borderColor: 'magenta', fill: false }] },
        options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });

    const altChart = new Chart(altCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Altitude (km)', data: [], borderColor: 'yellow', fill: false }] },
        options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });

    // Fetch data and update dashboard
    async function updateData() {
        try {
            const response = await fetch("/data");
            const data = await response.json();
            if (!data.length) return;

            const latest = data[data.length - 1];
            const timestamps = data.map(d => new Date(d[0]*1000).toLocaleTimeString());
            const latitudes = data.map(d => parseFloat(d[1]));
            const longitudes = data.map(d => parseFloat(d[2]));
            const altitudes = data.map(d => parseFloat(d[3]));

            // Update info
            document.getElementById("timestamp").innerText = new Date(latest[0]*1000).toLocaleString();
            document.getElementById("altitude").innerText = latest[3];

            // Update charts
            latChart.data.labels = timestamps;
            latChart.data.datasets[0].data = latitudes;
            latChart.update();

            lonChart.data.labels = timestamps;
            lonChart.data.datasets[0].data = longitudes;
            lonChart.update();

            altChart.data.labels = timestamps;
            altChart.data.datasets[0].data = altitudes;
            altChart.update();

            // Update ISS marker
            const lat = parseFloat(latest[1]);
            const lon = parseFloat(latest[2]);
            issMarker.setLatLng([lat, lon])
                     .setPopupContent(`ISS Position:<br>Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)}`)
                     .openPopup();
            map.setView([lat, lon], map.getZoom());

        } catch (err) {
            console.error("Error fetching data:", err);
        }
    }

    // Initial load
    updateData();
    // Refresh every 60 seconds
    setInterval(updateData, 60000);
</script>

</body>
</html>
